<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mille 1 Orders</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>

.modal {
  display: none; /* hidden by default */
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: flex; align-items: center; justify-content: center;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  animation: pop 0.3s ease;
}
@keyframes pop {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
.modal-content h2 {
  margin-top: 0;
  color: #ef4444;
}
.modal-content button {
  margin-top: 15px;
  padding: 8px 14px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}  
    body.staff { font-family: sans-serif; background: #f9f9f9; padding: 12px; }
    h1 { text-align: center; font-size: 1.3em; margin-bottom: 10px; }
    #orderFilters { position: sticky; top: 0; background: #f9f9f9; padding: 6px 0; z-index: 10;
      display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    #orderFilters .btn.active { background: #3b82f6; color: white; }
    .order { background: white; border-radius: 6px; padding: 8px 10px; margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9rem; line-height: 1.2; }
    .order p { margin: 2px 0; }
    .order strong { display: inline-block; min-width: 90px; }
    .status { font-weight: bold; color: #444; margin-top: 4px; }
    .btn { margin: 4px 4px 0 0; padding: 6px 10px; border: none; border-radius: 4px;
      cursor: pointer; font-size: 0.85rem; }
    .paid { background: #c3e6cb; }
    .receive { background: #bee5eb; }
    #orderDate { font-size: 0.95rem; padding: 4px; margin: 8px auto; width: 100%; max-width: 250px; display: block; }
    @media (max-width: 600px) {
      h1 { font-size: 1.1rem; }
      .btn { display: block; width: 100%; margin: 4px 0; }
      .order { font-size: 0.85rem; padding: 8px; }
    }
    /* Modal */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%;
      text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); animation: pop 0.3s ease; }
    @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-content h2 { margin-top: 0; color: #ef4444; }
    .modal-content button { margin-top: 15px; padding: 8px 14px; background: #3b82f6; color: #fff;
      border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body class="staff">
  <h1>üçΩ Mille 1 Orders</h1>

  <div id="orderFilters">
    <button onclick="filterOrders('all')" class="btn active">All</button>
    <button onclick="filterOrders('pending')" class="btn">Pending</button>
    <button onclick="filterOrders('paid')" class="btn">Paid</button>
    <button onclick="filterOrders('received')" class="btn">Received</button>
  </div>

  <h2 style="text-align:center;">Orders for <input type="date" id="orderDate" /></h2>
  <div id="orderList"></div>

  <!-- üö® Modal -->
  <div id="orderModal" class="modal">
    <div class="modal-content">
      <h2>üö® New Order Alert</h2>
      <p id="modalText"></p>
      <button id="closeModal">Close</button>
    </div>
  </div>

  <!-- Chime -->
  <audio id="newOrderSound" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3" preload="auto"></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
  authDomain: "e-loyalty-12563.firebaseapp.com",
  projectId: "e-loyalty-12563",
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const orderList = document.getElementById("orderList");
const orderDate = document.getElementById("orderDate");
const chime = document.getElementById("newOrderSound");
const modal = document.getElementById("orderModal");
const modalText = document.getElementById("modalText");
orderDate.valueAsDate = new Date();

let currentFilter = "all";
let ringingIntervals = {};
let shownModals = new Set();

// Close modal
document.getElementById("closeModal").addEventListener("click", () => {
  modal.style.display = "none";
  for (const key in ringingIntervals) {
    clearInterval(ringingIntervals[key]);
    delete ringingIntervals[key];
  }
});

// üé® Style
function styleMilleOrderBox(el, status) {
  const palette = {
    pending: { bg: "#ffffff", border: "#e5e7eb", text: "#111827" },
    paid: { bg: "#ecfdf5", border: "#10b981", text: "#064e3b" },
    received: { bg: "#eff6ff", border: "#3b82f6", text: "#1e3a8a" },
    default: { bg: "#f9fafb", border: "#e5e7eb", text: "#111827" }
  };
  const c = palette[status] || palette.default;
  el.style.backgroundColor = c.bg;
  el.style.border = `1px solid ${c.border}`;
  el.style.color = c.text;
}

function renderOrder(id, data) {
  const total = data.grandTotal ?? data.total ?? 0;
  const method = (data.paymentMethod || "Unspecified").toLowerCase();
  let milleStatus = data.milleStatus || "pending";
  const paymentStatus = (data.paymentStatus || "pending").toLowerCase();
  const kitchenStatus = ((data.kitchenStatus || data.status) || "").toLowerCase();
  const isMilleTable = /mille\s*1/i.test(data.table || "");
  const time = data.timestamp?.toDate?.().toLocaleTimeString("id-ID",{hour:'2-digit',minute:'2-digit'}) || "‚Äî";
  const date = data.date || "‚Äî";

  const div = document.createElement("div");
  div.className = "order";
  div.dataset.status = milleStatus;
  div.dataset.id = id;

  // Cancelled check
  if (kitchenStatus === "cancelled" && milleStatus !== "cancelled_by_kitchen") {
    db.collection("orders").doc(id).update({ milleStatus: "cancelled_by_kitchen" });
    milleStatus = "cancelled_by_kitchen";
  }

  if (milleStatus === "cancelled_by_kitchen") {
    div.style.backgroundColor = "#fee2e2";
    div.style.border = "1px solid #ef4444";
    div.style.color = "#991b1b";
  } else {
    styleMilleOrderBox(div, milleStatus);
  }

  // Buttons
  const paidBtn = document.createElement("button");
  paidBtn.className = "btn paid";
  paidBtn.textContent = "‚úÖ Have Paid";
  paidBtn.onclick = () => markPaid(id);

  const receiveBtn = document.createElement("button");
  receiveBtn.className = "btn receive";
  receiveBtn.textContent = "üì• Receive";
  receiveBtn.onclick = () => markReceived(id);

  // Disable for QRIS awaiting proof
  if (method.includes("qris") && paymentStatus === "awaiting-proof") {
    paidBtn.disabled = true;
    receiveBtn.disabled = true;
    paidBtn.style.opacity = "0.5";
    receiveBtn.style.opacity = "0.5";
  }

  // Disable kitchen updates for Mille tables
  if (isMilleTable) {
    receiveBtn.disabled = true;
    receiveBtn.style.opacity = "0.5";
  } else if (kitchenStatus !== "served") {
    receiveBtn.disabled = true;
    receiveBtn.style.opacity = "0.5";
  }

  if (milleStatus === "cancelled_by_kitchen") {
    paidBtn.disabled = true;
    receiveBtn.disabled = true;
    paidBtn.style.opacity = "0.5";
    receiveBtn.style.opacity = "0.5";
  }

  const waBtn = document.createElement("a");
  waBtn.className = "btn";
  waBtn.style.background = "#25D366";
  waBtn.style.color = "#fff";
  waBtn.href = `https://wa.me/6282188884663?text=Hello%20Cafe,%20please%20check%20order%20${id}%20(${data.table || "Mille 1"})`;
  waBtn.target = "_blank";
  waBtn.textContent = "üí¨ Contact Cafe";

  div.innerHTML = `
    <p><strong>Table:</strong> ${data.table || "?"}</p>
    <p><strong>Items:</strong> ${(data.items || []).map(i => `${i.qty}√ó ${i.name}`).join(", ")}</p>
    <p><strong>Grand Total:</strong> Rp ${total.toLocaleString("id-ID")}</p>
    <p><strong>Payment:</strong> ${data.paymentMethod || "Unspecified"} (${paymentStatus})</p>
    <p><strong>Time:</strong> ${time} | <strong>Date:</strong> ${date}</p>
    <p class="status">Mille Status: ${milleStatus.replace("_"," ")}<br/>Kitchen Status: ${kitchenStatus || "‚Äî"}</p>
  `;
  div.appendChild(paidBtn);
  div.appendChild(receiveBtn);
  div.appendChild(waBtn);

  // üö® Modal alert
  if (milleStatus === "pending" && kitchenStatus !== "cancelled" && !shownModals.has(id)) {
    modal.style.display = "flex";
    modalText.textContent = `New order from ${data.table || "unknown table"} with total Rp ${total.toLocaleString("id-ID")}`;
    shownModals.add(id);

    if (method.includes("cash")) {
      if (!ringingIntervals[id]) {
        chime.play();
        ringingIntervals[id] = setInterval(() => chime.play(), 5000);
      }
    } else if (method.includes("qris")) {
      chime.play();
    }
  }

  return div;
}

async function markPaid(id) {
  await db.collection("orders").doc(id).update({ milleStatus: "paid", paymentStatus: "success" });
  if (ringingIntervals[id]) { clearInterval(ringingIntervals[id]); delete ringingIntervals[id]; }
  alert("‚úÖ Order marked as Paid");
}

async function markReceived(id) {
  await db.collection("orders").doc(id).update({ milleStatus: "received" });
  alert("üì• Order marked as Received");
}

function loadOrders() {
  const yyyyMmDd = new Date(orderDate.value).toISOString().split("T")[0];
  db.collection("orders").where("date","==",yyyyMmDd).orderBy("timestamp","desc").onSnapshot(snapshot => {
    orderList.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.table && /mille\s*1/i.test(data.table)) {
        const card = renderOrder(doc.id, data);
        if (currentFilter === "all" || card.dataset.status === currentFilter) {
          orderList.appendChild(card);
        }
      }
    });
  });
}

function filterOrders(status) {
  currentFilter = status;
  document.querySelectorAll("#orderFilters .btn").forEach(btn => btn.classList.remove("active"));
  const activeBtn = [...document.querySelectorAll("#orderFilters .btn")].find(b => b.textContent.toLowerCase().includes(status));
  if (activeBtn) activeBtn.classList.add("active");
  loadOrders();
}

orderDate.addEventListener("change", loadOrders);
loadOrders();
</script>
</body>
</html>