<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>13e CafÃ© â€” Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #101828;
      --ink: #e6eefc;
      --muted: #93a1c7;
      --accent: #2f6feb;
      --accent-2: #10b981;
      --accent-3: #eab308;
      --border: #1f2b4a;
      --bronze: #cd7f32;
      --silver: #c0c0c0;
      --gold: #ffd700;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--ink); background: linear-gradient(180deg, #071024, #0b1220 30%); }
    header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: rgba(11,18,32,0.9); backdrop-filter: blur(6px); }
    header h1 { margin: 0; font-size: 18px; letter-spacing: 0.2px; }
    header nav a { color: var(--muted); text-decoration: none; margin-left: 14px; font-size: 14px; }
    header nav a.active, header nav a:hover { color: var(--ink); }
    main { max-width: 1100px; padding: 24px 16px 60px; margin: 0 auto; }

    .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 18px; }
    .card { background: rgba(16,24,40,0.72); border: 1px solid var(--border); border-radius: 14px; padding: 18px; }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .sub { color: var(--muted); font-size: 13px; margin: 0 0 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .buttons { display: flex; gap: 8px; align-items: center; }
    .btn { border: 1px solid var(--border); background: #0f172a; color: var(--ink); padding: 8px 12px; border-radius: 10px; font-size: 13px; cursor: pointer; }
    .btn:hover { border-color: #2a3a66; }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-primary:hover { filter: brightness(1.05); }
    .tag { display: inline-block; background: #0b132a; border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; font-size: 12px; color: var(--muted); }
    .list { display: grid; gap: 8px; }
    .item { display: flex; justify-content: space-between; align-items: center; background: rgba(13,20,36,0.7); border: 1px solid var(--border); padding: 10px 12px; border-radius: 10px; }
    .item .name { color: var(--ink); font-weight: 600; }
    .item .meta { color: var(--muted); font-size: 12px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .tier-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; }
    .tier-bronze { background: var(--bronze); }
    .tier-silver { background: var(--silver); }
    .tier-gold { background: var(--gold); }
    .muted { color: var(--muted); }
    .skeleton { background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 8px; height: 12px; }
    .s1 { width: 30%; }
    .s2 { width: 60%; }
    .s3 { width: 90%; }
    canvas { max-width: 100%; }
    a { color: #9ec4ff; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body>
  <header>
    <h1>ðŸ“Š 13e CafÃ© â€” Dashboard</h1>
    <nav>
      <a href="index.html">Members</a>
      <a href="settings.html">Settings</a>
      <a class="active" href="dashboard.html">Dashboard</a>
    </nav>
  </header>

  <main>
    <div class="actions" style="margin-bottom:14px;">
      <div class="buttons">
        <button id="refreshBtn" class="btn btn-primary">âŸ³ Refresh</button>
        <span id="lastUpdated" class="muted">â€”</span>
      </div>
      <span class="tag">This Year overview</span>
    </div>

    <div class="grid">
      <section class="card">
        <h2>Members by tier</h2>
        <p class="sub">Distribution across Bronze, Silver, and Gold.</p>
        <canvas id="tierChart" height="200"></canvas>
        <div id="tierChartLegend" class="muted" style="margin-top:10px;"></div>
      </section>

      <section class="card">
        <h2>Top members</h2>
        <p class="sub">Ranked by total spend this year.</p>
        <div id="topMembers" class="list">
          <div class="item"><span class="skeleton s2"></span></div>
          <div class="item"><span class="skeleton s3"></span></div>
          <div class="item"><span class="skeleton s2"></span></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:18px;">
      <h2>Recent activity</h2>
      <p class="sub">Latest transactions across all members.</p>
      <div id="activityFeed" class="list">
        <div class="item"><span class="skeleton s3"></span></div>
        <div class="item"><span class="skeleton s2"></span></div>
        <div class="item"><span class="skeleton s3"></span></div>
      </div>
    </section>
  </main>

  <script>
    // Firebase init (compat). Uses your project config; only initializes if not already.
    (function initFirebase() {
      const cfg = {
        apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
        authDomain: "e-loyalty-12563.firebaseapp.com",
        projectId: "e-loyalty-12563",
        storageBucket: "e-loyalty-12563.appspot.com",
        messagingSenderId: "3887061029",
        appId: "1:3887061029:web:f9c238731d7e6dd5fb47cc",
        measurementId: "G-966P8W06W2"
      };
      if (!firebase.apps.length) firebase.initializeApp(cfg);
      window.db = window.db || firebase.firestore();
    })();

    // Helpers
    const fmtRp = n => "Rp" + (Number(n||0)).toLocaleString("id-ID");
    const by = key => (a,b) => (a[key] > b[key] ? -1 : a[key] < b[key] ? 1 : 0);

    // Fetch all members once
    async function fetchMembers() {
      const snap = await db.collection("members").get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    function computeYearSpend(member, year) {
      const txs = Array.isArray(member.transactions) ? member.transactions : [];
      return txs.reduce((sum, tx) => {
        const d = new Date(tx.date);
        return d.getFullYear() === year ? sum + (tx.amount || 0) : sum;
      }, 0);
    }

    // Render Tier Chart
    let tierChartInstance = null;
    function renderTierChart(counts) {
      const ctx = document.getElementById("tierChart").getContext("2d");
      if (tierChartInstance) { tierChartInstance.destroy(); tierChartInstance = null; }
      tierChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Bronze", "Silver", "Gold"],
          datasets: [{
            data: [counts.Bronze||0, counts.Silver||0, counts.Gold||0],
            backgroundColor: ["#cd7f32", "#c0c0c0", "#ffd700"],
            borderColor: "#0b1220",
            borderWidth: 2
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          }
        }
      });
      const legend = document.getElementById("tierChartLegend");
      legend.innerHTML = `
        <span class="tier-dot tier-bronze"></span> Bronze: ${counts.Bronze||0} &nbsp;&nbsp;
        <span class="tier-dot tier-silver"></span> Silver: ${counts.Silver||0} &nbsp;&nbsp;
        <span class="tier-dot tier-gold"></span> Gold: ${counts.Gold||0}
      `;
    }

    // Render Top Members
    function renderTopMembers(members, year, topN = 5) {
      const ranked = members.map(m => ({
        id: m.id,
        name: m.name || "(Unnamed)",
        tier: (m.tier || "Bronze").trim(),
        spend: computeYearSpend(m, year)
      })).sort(by("spend")).slice(0, topN);

      const root = document.getElementById("topMembers");
      if (!ranked.length) { root.innerHTML = '<div class="muted">No data yet.</div>'; return; }

      root.innerHTML = ranked.map((m, i) => {
        const tierClass = "tier-" + (m.tier || "Bronze").toLowerCase();
        return `
          <div class="item">
            <div>
              <span class="tier-dot ${tierClass}"></span>
              <a class="name" href="details.html?id=${m.id}">${i+1}. ${m.name}</a>
              <span class="meta">(${m.tier})</span>
            </div>
            <div class="mono">${fmtRp(m.spend)}</div>
          </div>
        `;
      }).join("");
    }

    // Render Activity Feed
    function renderActivityFeed(members, limit = 20) {
      const events = [];
      const push = (name, tx) => {
        if (!tx?.date || !tx?.amount) return;
        const d = new Date(tx.date);
        if (isNaN(d)) return;
        events.push({ name, date: d, amount: tx.amount });
      };
      for (const m of members) {
        const txs = Array.isArray(m.transactions) ? m.transactions : [];
        for (const tx of txs) push(m.name || "(Unnamed)", tx);
      }
      events.sort((a,b) => b.date - a.date);
      const recent = events.slice(0, limit);

      const root = document.getElementById("activityFeed");
      if (!recent.length) { root.innerHTML = '<div class="muted">No recent activity.</div>'; return; }

      root.innerHTML = recent.map(e => `
        <div class="item">
          <div>
            <span class="name">${e.name}</span>
            <span class="meta"> â€¢ ${e.date.toLocaleString()}</span>
          </div>
          <div class="mono">${fmtRp(e.amount)}</div>
        </div>
      `).join("");
    }

    async function loadDashboard() {
      const now = new Date();
      const year = now.getFullYear();
      const tsEl = document.getElementById("lastUpdated");
      tsEl.textContent = "Loadingâ€¦";

      try {
        const members = await fetchMembers();

        // Compute counts for chart
        const counts = { Bronze: 0, Silver: 0, Gold: 0 };
        for (const m of members) {
          const t = (m.tier || "Bronze").trim();
          if (counts[t] !== undefined) counts[t]++;
        }

        // Render sections
        renderTierChart(counts);
        renderTopMembers(members, year, 5);
        renderActivityFeed(members, 20);

        tsEl.textContent = "Updated " + new Date().toLocaleTimeString();
      } catch (err) {
        console.error("Dashboard load failed:", err);
        tsEl.textContent = "Failed to load.";
        // fallback UI
        document.getElementById("topMembers").innerHTML = '<div class="muted">Failed to load.</div>';
        document.getElementById("activityFeed").innerHTML = '<div class="muted">Failed to load.</div>';
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("refreshBtn").addEventListener("click", loadDashboard);
      loadDashboard();
    });
  </script>
</body>
</html>