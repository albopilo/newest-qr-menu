<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>13e Caf√© ‚Äî Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --accent: #2f6feb;
      --danger: #b71c1c;
      --muted: #666;
      --bg: #f7f9fc;
      --card: #fff;
      --border: #e6eaf2;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); margin: 0; }
    header { background: #111827; color: #fff; padding: 18px 22px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { font-size: 18px; margin: 0; }
    header nav a { color: #cbd5e1; text-decoration: none; margin-left: 16px; font-size: 14px; }
    main { max-width: 960px; margin: 28px auto; padding: 0 16px 48px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px; }
    .card h2 { margin: 0 0 10px; font-size: 16px; }
    .card p.help { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
    .field { margin: 10px 0 6px; }
    .field label { display: block; font-size: 13px; color: #111827; margin-bottom: 6px; }
    .field input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .actions { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button { border: 1px solid transparent; border-radius: 8px; padding: 10px 14px; font-size: 14px; cursor: pointer; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-outline { background: #fff; border-color: var(--border); color: #111827; }
    .btn-danger { background: var(--danger); color: #fff; }
    .muted { color: var(--muted); font-size: 12px; }
    .divider { height: 1px; background: var(--border); margin: 18px 0; }
    .stack { display: grid; gap: 10px; }
    .inline { display: flex; gap: 10px; align-items: center; }
    .hidden { display: none !important; }
    .success { color: #0b8f3b; font-size: 13px; }
    .error { color: #b71c1c; font-size: 13px; }
  </style>

  <!-- Admin gate -->
  <script>
    (function adminGate() {
      const isAdmin = localStorage.getItem("isAdmin") === "true" || localStorage.getItem("mode") === "admin";
      if (!isAdmin) {
        alert("üîê Admins only");
        location.href = "index.html";
      }
    })();
  </script>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>13e Caf√© ‚Äî Settings</h1>
    <nav>
      <a href="index.html">Members</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="settings.html" style="color:#fff;">Settings</a>
    </nav>
  </header>

  <main>
    <div class="row">
      <section class="card">
        <h2>Tier thresholds</h2>
        <p class="help">Rules for moving up or maintaining tiers. All values are in Rupiah.</p>
        <div class="row">
          <div class="card">
            <h2>Bronze ‚Üí Silver</h2>
            <div class="field">
              <label>Monthly threshold</label>
              <input type="number" id="monthlyThreshold" placeholder="e.g., 500000" min="0" />
            </div>
            <div class="field">
              <label>Yearly threshold</label>
              <input type="number" id="yearlyThreshold" placeholder="e.g., 1200000" min="0" />
            </div>
          </div>
          <div class="card">
            <h2>Silver</h2>
            <div class="field">
              <label>Maintain Silver (Yearly)</label>
              <input type="number" id="maintainSilver" placeholder="e.g., 500000" min="0" />
            </div>
            <div class="field">
              <label>Silver ‚Üí Gold (Monthly)</label>
              <input type="number" id="silverToGoldMonth" placeholder="e.g., 1250000" min="0" />
            </div>
            <div class="field">
              <label>Silver ‚Üí Gold (Yearly)</label>
              <input type="number" id="silverToGoldYear" placeholder="e.g., 4000000" min="0" />
            </div>
          </div>
        </div>
        <div class="field">
          <label>Gold maintain (Yearly)</label>
          <input type="number" id="maintainGoldYear" placeholder="e.g., 2000000" min="0" />
        </div>
        <div class="actions">
          <button class="btn-primary" id="saveTierBtn">üíæ Save thresholds</button>
          <span id="tierSaveMsg" class="muted"></span>
        </div>
      </section>

      <section class="card">
        <h2>Cashback settings</h2>
        <p class="help">Rates and daily caps used when calculating cashback on transactions.</p>
        <div class="row">
          <div class="card">
            <h2>Rates</h2>
            <div class="field">
              <label>Silver cashback rate (%)</label>
              <input type="number" id="silverRate" placeholder="e.g., 5" min="0" />
            </div>
            <div class="field">
              <label>Gold cashback rate (%)</label>
              <input type="number" id="goldRate" placeholder="e.g., 5" min="0" />
            </div>
            <div class="field">
              <label>Birthday Gold cashback (%)</label>
              <input type="number" id="birthdayGold" placeholder="e.g., 30" min="0" />
            </div>
          </div>
          <div class="card">
            <h2>Daily caps</h2>
            <div class="field">
              <label>Silver daily cap (Rp)</label>
              <input type="number" id="silverCap" placeholder="e.g., 15000" min="0" />
            </div>
            <div class="field">
              <label>Gold daily cap (Rp)</label>
              <input type="number" id="goldCap" placeholder="e.g., 30000" min="0" />
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="btn-primary" id="saveCashbackBtn">üíæ Save cashback</button>
          <span id="cashbackSaveMsg" class="muted"></span>
        </div>
      </section>
    </div>

    <div class="divider"></div>

    <section class="card">
      <h2>Bulk actions</h2>
      <p class="help">Tools for admins. Recalculation uses the latest thresholds and current year/month.</p>
      <div class="actions">
        <button class="btn-danger" id="recalcTiersBtn">üîÑ Recalculate all member tiers</button>
        <span id="recalcMsg" class="muted"></span>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <div class="inline">
          <button class="btn-outline" id="backupMembersBtn">‚¨áÔ∏è Backup members (JSON)</button>
          <span class="muted">Download a JSON snapshot of all members</span>
        </div>
        <div class="inline">
          <input type="file" id="restoreFileInput" accept="application/json" />
          <button class="btn-outline" id="restoreBtn">‚¨ÜÔ∏è Restore from JSON</button>
          <span class="muted">Restore members from a previous backup (overwrites individual docs)</span>
        </div>
      </div>
      <span id="backupRestoreMsg" class="muted"></span>
    </section>
  </main>

  <script>
    // Firebase config (compat)
    const firebaseConfig = {
      apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
      authDomain: "e-loyalty-12563.firebaseapp.com",
      projectId: "e-loyalty-12563",
      storageBucket: "e-loyalty-12563.appspot.com",
      messagingSenderId: "3887061029",
      appId: "1:3887061029:web:f9c238731d7e6dd5fb47cc",
      measurementId: "G-966P8W06W2"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Settings document references
    const thresholdsRef = db.collection("settings").doc("tierThresholds");
    const cashbackRef   = db.collection("settings").doc("cashbackRates");

    // --- Loaders
    async function loadTierSettings() {
      const msg = document.getElementById("tierSaveMsg");
      msg.textContent = "Loading‚Ä¶";
      try {
        const snap = await thresholdsRef.get();
        if (snap.exists) {
          const t = snap.data() || {};
          document.getElementById("monthlyThreshold").value   = t.bronzeToSilverMonth ?? 500000;
          document.getElementById("yearlyThreshold").value    = t.bronzeToSilverYear  ?? 1200000;
          document.getElementById("maintainSilver").value     = t.silverStayYear      ?? 500000;
          document.getElementById("silverToGoldMonth").value  = t.silverToGoldMonth   ?? 1250000;
          document.getElementById("silverToGoldYear").value   = t.silverToGoldYear    ?? 4000000;
          document.getElementById("maintainGoldYear").value   = t.goldStayYear        ?? 2000000;
          msg.textContent = "Loaded.";
        } else {
          msg.textContent = "No saved thresholds. Using defaults.";
        }
      } catch (err) {
        console.error("Tier load error:", err);
        msg.innerHTML = `<span class="error">Failed to load</span>`;
      }
    }

    async function loadCashbackSettings() {
      const msg = document.getElementById("cashbackSaveMsg");
      msg.textContent = "Loading‚Ä¶";
      try {
        const snap = await cashbackRef.get();
        if (snap.exists) {
          const c = snap.data() || {};
          document.getElementById("silverRate").value   = c.silverCashbackRate       ?? 5;
          document.getElementById("goldRate").value     = c.goldCashbackRate         ?? 5;
          document.getElementById("birthdayGold").value = c.birthdayGoldCashbackRate ?? 30;
          document.getElementById("silverCap").value    = c.silverDailyCashbackCap   ?? 15000;
          document.getElementById("goldCap").value      = c.goldDailyCashbackCap     ?? 30000;
          msg.textContent = "Loaded.";
        } else {
          msg.textContent = "No saved cashback. Using defaults.";
        }
      } catch (err) {
        console.error("Cashback load error:", err);
        msg.innerHTML = `<span class="error">Failed to load</span>`;
      }
    }

    // --- Savers
    async function saveTierSettings() {
      const msg = document.getElementById("tierSaveMsg");
      msg.textContent = "Saving‚Ä¶";
      const payload = {
        bronzeToSilverMonth: parseInt(document.getElementById("monthlyThreshold").value)   || 0,
        bronzeToSilverYear:  parseInt(document.getElementById("yearlyThreshold").value)    || 0,
        silverStayYear:      parseInt(document.getElementById("maintainSilver").value)     || 0,
        silverToGoldMonth:   parseInt(document.getElementById("silverToGoldMonth").value)  || 0,
        silverToGoldYear:    parseInt(document.getElementById("silverToGoldYear").value)   || 0,
        goldStayYear:        parseInt(document.getElementById("maintainGoldYear").value)   || 0
      };
      try {
        await thresholdsRef.set(payload, { merge: true });
        msg.innerHTML = `<span class="success">Saved.</span>`;
      } catch (err) {
        console.error("Tier save error:", err);
        msg.innerHTML = `<span class="error">Failed to save</span>`;
      }
    }

    async function saveCashbackSettings() {
      const msg = document.getElementById("cashbackSaveMsg");
      msg.textContent = "Saving‚Ä¶";
      const payload = {
        silverCashbackRate:       parseInt(document.getElementById("silverRate").value)   || 0,
        goldCashbackRate:         parseInt(document.getElementById("goldRate").value)     || 0,
        birthdayGoldCashbackRate: parseInt(document.getElementById("birthdayGold").value) || 0,
        silverDailyCashbackCap:   parseInt(document.getElementById("silverCap").value)    || 0,
        goldDailyCashbackCap:     parseInt(document.getElementById("goldCap").value)      || 0
      };
      try {
        await cashbackRef.set(payload, { merge: true });
        msg.innerHTML = `<span class="success">Saved.</span>`;
      } catch (err) {
        console.error("Cashback save error:", err);
        msg.innerHTML = `<span class="error">Failed to save</span>`;
      }
    }

    // --- Recalc tiers (chunked)
    async function recalcAllTiers() {
      const msg = document.getElementById("recalcMsg");
      msg.textContent = "Preparing‚Ä¶";

      // Load latest thresholds
      const thrSnap = await thresholdsRef.get();
      const t = thrSnap.exists ? thrSnap.data() : {};
      const thresholds = {
        bronzeToSilverMonth: t.bronzeToSilverMonth ?? 500000,
        bronzeToSilverYear:  t.bronzeToSilverYear  ?? 1200000,
        silverStayYear:      t.silverStayYear      ?? 500000,
        silverToGoldMonth:   t.silverToGoldMonth   ?? 1250000,
        silverToGoldYear:    t.silverToGoldYear    ?? 4000000,
        goldStayYear:        t.goldStayYear        ?? 2000000
      };

      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.getMonth();

      let processed = 0;
      let lastDoc = null;
      msg.textContent = "Recalculating‚Ä¶";

      while (true) {
        let q = db.collection("members").orderBy("nameLower").limit(400);
        if (lastDoc) q = q.startAfter(lastDoc);
        const snap = await q.get();
        if (snap.empty) break;

        const batch = db.batch();
        snap.docs.forEach(doc => {
          const m = doc.data() || {};
          const id = doc.id;

          const txs = Array.isArray(m.transactions) ? m.transactions : [];
          let monthlySinceUpgrade = 0;
          let yearlySinceUpgrade = 0;

          const upgradeDate = m.upgradeDate ? new Date(m.upgradeDate) : null;

          txs.forEach(tx => {
            const d = new Date(tx.date);
            if (d.getFullYear() === currentYear) {
              if (!upgradeDate || d > upgradeDate) {
                yearlySinceUpgrade += tx.amount || 0;
                if (d.getMonth() === currentMonth) monthlySinceUpgrade += tx.amount || 0;
              }
            }
          });

          // Creation-year demotion protection
          let createdYear = null;
          if (m.createdAt) {
            const cd = m.createdAt.toDate ? m.createdAt.toDate() : new Date(m.createdAt);
            if (cd instanceof Date && !isNaN(cd)) createdYear = cd.getFullYear();
          }
          const isNewThisYear = createdYear === currentYear;

          const currentTier = ((m.tier || "Bronze") + "").trim().toLowerCase();
          let newTier = currentTier;

          if (currentTier === "bronze") {
            if (monthlySinceUpgrade >= thresholds.bronzeToSilverMonth || yearlySinceUpgrade >= thresholds.bronzeToSilverYear) {
              newTier = "silver";
            }
          } else if (currentTier === "silver") {
            if (monthlySinceUpgrade >= thresholds.silverToGoldMonth || yearlySinceUpgrade >= thresholds.silverToGoldYear) {
              newTier = "gold";
            } else if (!isNewThisYear && yearlySinceUpgrade < thresholds.silverStayYear) {
              newTier = "bronze";
            }
          } else if (currentTier === "gold") {
            if (!isNewThisYear && yearlySinceUpgrade < thresholds.goldStayYear) {
              newTier = "silver";
            }
          }

          const properTier = newTier.charAt(0).toUpperCase() + newTier.slice(1).toLowerCase();
          const update = {
            monthlySinceUpgrade,
            yearlySinceUpgrade,
            tier: properTier
          };

          // Reset since-upgrade counters on upgrade
          if (newTier !== currentTier && (currentTier === "bronze" || currentTier === "silver")) {
            update.upgradeDate = now.toISOString();
            update.monthlySinceUpgrade = 0;
            update.yearlySinceUpgrade = 0;
          }

          batch.update(db.collection("members").doc(id), update);
        });

        await batch.commit();
        processed += snap.size;
        lastDoc = snap.docs[snap.docs.length - 1];
        msg.textContent = `Processed ${processed} members‚Ä¶`;
      }

      msg.innerHTML = `<span class="success">Done. Recalculated ${processed} members.</span>`;
      alert(`‚úÖ Recalculated ${processed} members.`);
    }

    // --- Backup / Restore
    async function backupMembers() {
      const msg = document.getElementById("backupRestoreMsg");
      msg.textContent = "Building backup‚Ä¶";
      try {
        const snap = await db.collection("members").get();
        const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const blob = new Blob([JSON.stringify(all, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `members-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        msg.innerHTML = `<span class="success">Backup ready.</span>`;
      } catch (err) {
        console.error("Backup failed:", err);
        msg.innerHTML = `<span class="error">Backup failed</span>`;
      }
    }

    async function restoreMembersFromFile(file) {
      const msg = document.getElementById("backupRestoreMsg");
      msg.textContent = "Restoring‚Ä¶";
      try {
        const text = await file.text();
        const members = JSON.parse(text);
        if (!Array.isArray(members)) throw new Error("Invalid backup format.");

        // chunk into batches of 400
        const chunk = (arr, size) => {
          const res = [];
          for (let i = 0; i < arr.length; i += size) res.push(arr.slice(i, i + size));
          return res;
        };
        const chunks = chunk(members, 400);
        let done = 0;
        for (const part of chunks) {
          const batch = db.batch();
          part.forEach(m => {
            if (!m.id) return;
            batch.set(db.collection("members").doc(m.id), m, { merge: true });
          });
          await batch.commit();
          done += part.length;
          msg.textContent = `Restored ${done}/${members.length}‚Ä¶`;
        }
        msg.innerHTML = `<span class="success">Restore complete (${members.length}).</span>`;
        alert(`‚úÖ Restored ${members.length} members.`);
      } catch (err) {
        console.error("Restore failed:", err);
        msg.innerHTML = `<span class="error">Restore failed</span>`;
      }
    }

    // --- Wire up
    document.addEventListener("DOMContentLoaded", () => {
      // Load settings
      loadTierSettings();
      loadCashbackSettings();

      // Save buttons
      document.getElementById("saveTierBtn").addEventListener("click", saveTierSettings);
      document.getElementById("saveCashbackBtn").addEventListener("click", saveCashbackSettings);

      // Recalc
      document.getElementById("recalcTiersBtn").addEventListener("click", async () => {
        if (!confirm("Recalculate tiers for ALL members now?")) return;
        await recalcAllTiers();
      });

      // Backup
      document.getElementById("backupMembersBtn").addEventListener("click", backupMembers);

      // Restore
      const restoreInput = document.getElementById("restoreFileInput");
      document.getElementById("restoreBtn").addEventListener("click", () => restoreInput.click());
      restoreInput.addEventListener("change", e => {
        const f = e.target.files?.[0];
        if (f) restoreMembersFromFile(f);
        e.target.value = "";
      });
    });
  </script>
</body>
</html>