<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Staff Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f9f9f9;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
    }
    body.staff {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      margin: 0; padding: 18px;
      color: #111827;
    }
    h1 { text-align:center; margin: 0 0 12px; font-size: 1.4rem; }

    #orderControls {
      display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;
      margin-bottom:12px; position: sticky; top:0; background:var(--bg);
      padding:8px 0; z-index:30;
    }

    .btn {
      border: none; padding: 8px 12px; border-radius:8px;
      background:#e5e7eb; cursor:pointer; font-size:0.95rem; transition:background .15s;
    }
    .btn:hover { background:#d1d5db; }
    .btn.active { background: var(--accent); color: #fff; }

    #orderDate {
      padding:6px 8px; border-radius:8px; border:1px solid #d1d5db; font-size:1rem;
    }

    #orderList { margin-top: 12px; max-width: 840px; margin-inline:auto; }

    .order {
      background: var(--card); border-radius:10px; padding:12px;
      margin-bottom:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: box-shadow .18s, border-color .18s;
    }

    .order .meta {
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;
    }

    .order p { margin:6px 0; color:#111827; font-size:0.95rem; }
    .order ul { margin:6px 0 8px 18px; padding:0; }
    .order .status { font-weight:700; margin-top:6px; }

    .controls-row { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn.minimal { background:#f3f4f6; border-radius:6px; padding:7px 10px; }
    .btn.contact { background:#25D366; color:white; text-decoration:none; padding:7px 10px; border-radius:6px; }

    .loading, .empty { text-align:center; color:var(--muted); padding:18px 0; }

    .badge {
      padding:6px 8px; border-radius:999px; font-size:0.85rem; font-weight:600;
      display:inline-block;
    }
    .badge.pending { background:#fff7ed; color:#7c2d12; border:1px solid #f97316; }
    .badge.preparing { background:#eff6ff; color:#1e3a8a; border:1px solid #3b82f6; }
    .badge.served { background:#ecfdf5; color:#064e3b; border:1px solid #10b981; }
    .badge.cancelled { background:#fee2e2; color:#991b1b; border:1px solid #ef4444; }

    .topline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    @media (max-width:600px) {
      .meta { flex-direction:column; align-items:flex-start; }
      .controls-row { width:100%; }
      #orderControls { padding-inline:8px; }
    }
  </style>
</head>
<body class="staff">
  <h1>ðŸ“‹ Incoming Orders</h1>

  <div id="orderControls">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="btn active" data-filter="all">All</button>
      <button class="btn" data-filter="incoming">Incoming</button>
      <button class="btn" data-filter="served">Served</button>
      <button class="btn" data-filter="cancelled">Cancelled</button>
    </div>

    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <label for="orderDate" style="font-size:0.9rem; color:var(--muted);">Orders for</label>
      <input id="orderDate" type="date" />
    </div>
  </div>

  <div id="orderList" role="list"></div>

  <audio id="newOrderSound" preload="auto" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Shared Firebase logic -->
  <script src="app.js"></script>

  <!-- Staff Logic -->
<script>
(function(){
  const phoneMap = {
    "mille 1": "6282217091699",
    "mille 2": "6281220039853",
    "mille 3": "6282261863984",
  };

  const orderList = document.getElementById('orderList');
  const orderDate = document.getElementById('orderDate');
  const audio = document.getElementById('newOrderSound');
  const filterButtons = [...document.querySelectorAll('#orderControls .btn[data-filter]')];

  let loadedOrders = new Map();
  let currentFilter = 'incoming';
  let activeRepeaters = new Map(); // ðŸ”” track repeating chimes per order
  window._staff_unsub = window._staff_unsub || null;

  function getDb(){ return window.db || (window.firebase?.firestore?.()); }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function tsToJakartaTime(ts){
    if(!ts) return 'â€”';
    const d = ts.toDate?.() || new Date(ts);
    return d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Jakarta'});
  }

  function todayJakarta(){
    const d = new Date(new Date().toLocaleString('en-US',{timeZone:'Asia/Jakarta'}));
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function extractItems(data){
    const cands=[data.items,data.orderItems,data.products,data.orderedItems,data.orderData?.items,data.orderData?.products];
    for(const c of cands){
      if(Array.isArray(c)) return c;
      if(typeof c==='string'&&c.trim().startsWith('[')){
        try{return JSON.parse(c);}catch{}
      }
      if(c&&typeof c==='object'){
        const vals=Object.values(c);
        if(vals.length&&typeof vals[0]==='object')return vals;
      }
    }
    return [];
  }

  function badge(status){
    const s=(status||'').toLowerCase();
    if(s.includes('prepare'))return'<span class="badge preparing">PREPARING</span>';
    if(s.includes('serve'))return'<span class="badge served">SERVED</span>';
    if(s.includes('cancel'))return'<span class="badge cancelled">CANCELLED</span>';
    return'<span class="badge pending">PENDING</span>';
  }

  function createCard(id,data){
    const table=data.table||data.tableName||'â€”';
    const guest=data.guestName||'Guest';
    const items=extractItems(data);
    const time=tsToJakartaTime(data.timestamp||data.createdAt);
    const status=(data.kitchenStatus||data.status||'pending').toLowerCase();
    const method=(data.paymentMethod||'unspecified').toUpperCase();
    const payStatus=(data.paymentStatus||'unknown').toLowerCase();
    const subtotal=+data.subtotal||0,disc=+data.discount||0,tax=+data.tax||0,fee=+data.deliveryFee||0;
    const total=+data.grandTotal||subtotal-disc+tax+fee;

    const div=document.createElement('div');
    div.className='order'; div.dataset.status=status;
    div.innerHTML=`
      <div class="meta">
        <div>
          <div class="topline">
            <strong>${escapeHtml(table)}</strong>
            <span style="color:var(--muted)">${escapeHtml(guest)}</span>
          </div>
          <p><strong>Items:</strong></p>
          <ul>${items.map(i=>`<li>${i.qty||1}Ã— ${escapeHtml(i.name||i.itemName||'Unnamed')} â€” Rp${((i.qty||1)*(i.price||0)).toLocaleString('id-ID')}</li>`).join('')}</ul>
        </div>
        <div style="text-align:right">
          ${badge(status)}
          <div style="color:var(--muted);font-size:0.9rem;">${method} (${payStatus})</div>
          <div style="color:var(--muted);font-size:0.9rem;margin-top:6px;">${time}</div>
        </div>
      </div>
      <p><strong>Total:</strong> <span style="color:var(--success);font-weight:700">Rp${total.toLocaleString('id-ID')}</span></p>
      <p class="status">Status: ${status.toUpperCase()}</p>
    `;

    const ctrl=document.createElement('div');
    ctrl.className='controls-row';
    ['preparing','served','cancelled'].forEach(s=>{
      const b=document.createElement('button');
      b.className='btn minimal'; b.textContent=s;
      b.onclick=()=>updateStatus(id,s);
      ctrl.appendChild(b);
    });
    const lower=table.toLowerCase();
    const phone=(lower.includes('mille 1')&&phoneMap['mille 1'])||(lower.includes('mille 2')&&phoneMap['mille 2'])||(lower.includes('mille 3')&&phoneMap['mille 3']);
    if(phone){
      const a=document.createElement('a');
      a.className='btn contact';
      a.href=`https://wa.me/${phone}?text=${encodeURIComponent('Order '+id+' ('+table+')')}`;
      a.target='_blank'; a.textContent='ðŸ’¬ Contact Mille';
      ctrl.appendChild(a);
    }
    div.appendChild(ctrl);
    return div;
  }

  async function updateStatus(id,status){
    const db=getDb();
    if(!db)return alert('Firestore not ready');
    await db.collection('orders').doc(id).update({kitchenStatus:status});
    stopRepeatingChime(id); // âœ… stop chime when status updated
    showBanner(`âœ… Order ${id} â†’ ${status}`);
  }

  function showBanner(msg,ms=2500){
    const el=document.createElement('div');
    el.textContent=msg;
    Object.assign(el.style,{position:'fixed',bottom:'24px',left:'50%',transform:'translateX(-50%)',background:'#111',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:9999});
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),ms);
  }

  // ðŸ”” Repeat Chime Helpers
  function startRepeatingChime(id){
    if(activeRepeaters.has(id)) return; // already repeating
    const play = () => audio.play().catch(()=>{});
    const interval = setInterval(play, 20000); // repeat every 20s
    activeRepeaters.set(id, interval);
    play(); // immediate first play
  }

  function stopRepeatingChime(id){
    if(!activeRepeaters.has(id)) return;
    clearInterval(activeRepeaters.get(id));
    activeRepeaters.delete(id);
  }

  function stopAllChimes(){
    for(const [id,t] of activeRepeaters) clearInterval(t);
    activeRepeaters.clear();
  }

  function applyFilter(status){
    currentFilter=status;
    filterButtons.forEach(b=>b.classList.toggle('active',b.dataset.filter===status));
    document.querySelectorAll('.order').forEach(el=>{
      const s=el.dataset.status;
      const incoming=status==='incoming'&&['pending','preparing'].includes(s);
      el.style.display=(status==='all'||incoming||s===status)?'':'none';
    });
    const any=[...document.querySelectorAll('.order')].some(e=>e.style.display!=='none');
    if(!any)orderList.innerHTML+=`<div class="empty">No orders match filter.</div>`;
    else document.querySelectorAll('.empty').forEach(e=>e.remove());
  }

  function loadOrders(){
    const db=getDb();
    if(!db){orderList.innerHTML='<div class="loading">Waiting for Firestore...</div>';return;}
    const date=orderDate.value;
    if(!date){orderList.innerHTML='<div class="empty">Please select a date.</div>';return;}
    if(window._staff_unsub){try{window._staff_unsub();}catch{} window._staff_unsub=null;}
    stopAllChimes(); // clear on reload

    orderList.innerHTML='<div class="loading">Loading ordersâ€¦</div>';
    loadedOrders.clear();

    let initial=true;
    const q=db.collection('orders').where('date','==',date).orderBy('timestamp','desc');
    window._staff_unsub=q.onSnapshot(snap=>{
      if(snap.empty&&initial){orderList.innerHTML='<div class="empty">No orders for this date.</div>';return;}
      snap.docChanges().forEach(ch=>{
        const id=ch.doc.id,data=ch.doc.data();
        if(ch.type==='added'){
          const el=createCard(id,data);
          loadedOrders.set(id,el);
          orderList.prepend(el);
          if(!initial) startRepeatingChime(id); // ðŸ”” start chime for new orders
        }else if(ch.type==='modified'){
          const old=loadedOrders.get(id);
          const el=createCard(id,data);
          if(old&&old.parentElement)old.replaceWith(el);
          else orderList.prepend(el);
          loadedOrders.set(id,el);

          const s=(data.kitchenStatus||data.status||'').toLowerCase();
          if(['preparing','served','cancelled'].includes(s)) stopRepeatingChime(id);
        }else if(ch.type==='removed'){
          loadedOrders.get(id)?.remove();
          loadedOrders.delete(id);
          stopRepeatingChime(id);
        }
      });
      applyFilter(currentFilter);
      initial=false;
    },err=>{
      orderList.innerHTML=`<div class="empty">Error: ${err.message}</div>`;
    });
  }

  filterButtons.forEach(b=>b.onclick=()=>applyFilter(b.dataset.filter));
  orderDate.onchange=loadOrders;

  document.addEventListener('DOMContentLoaded',()=>{
    orderDate.value=todayJakarta();
    setTimeout(loadOrders,200);
  });

})();
</script>
</body>
</html>
