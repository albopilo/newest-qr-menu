<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body.staff {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 16px;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 12px;
    }
    #orderFilters {
      position: sticky;
      top: 0;
      background: #f9f9f9;
      padding: 10px 0;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    #orderFilters .btn.active {
      background: #3b82f6;
      color: white;
    }
    .order {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.95rem;
      transition: box-shadow 0.3s, border-color 0.3s;
    }
    .status {
      font-weight: bold;
      margin-top: 6px;
    }
    .btn {
      margin: 6px 4px 0 0;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .btn.minimal {
      background: #e5e7eb;
    }
    .btn.contact {
      background: #25D366;
      color: #fff;
    }
    #orderDate {
      font-size: 1rem;
      padding: 6px;
      margin: 10px 0;
      width: 100%;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.2rem; }
      .btn { display: block; width: 100%; margin: 6px 0; }
      .order { font-size: 0.9rem; padding: 10px; }
    }
  </style>
</head>

<body class="staff">
  <h1>üìã Incoming Orders</h1>

  <div id="orderFilters">
    <button onclick="filterOrders('all')" class="btn active">All</button>
    <button onclick="filterOrders('incoming')" class="btn">Incoming</button>
    <button onclick="filterOrders('served')" class="btn">Served</button>
    <button onclick="filterOrders('cancelled')" class="btn">Cancelled</button>
  </div>

  <h2 style="text-align:center;">Orders for <input type="date" id="orderDate" /></h2>
  <div id="orderList"></div>

  <audio id="newOrderSound" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3" preload="auto"></audio>
  <button id="installBtn" style="display:none;">Install App</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- ‚úÖ Load shared app logic (contains Firebase init + AudioChime + repeating chime) -->
  <script src="app.js"></script>

 <!-- ‚úÖ OneSignal push notification integration -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "9d4e981e-3184-4ebb-9ac1-cdb4644b1ccd",
    });
    console.log("üîî OneSignal initialized");
  });
</script>

<!-- ‚úÖ Staff Logic -->
<script>

// üß© Safety: prevent ReferenceError if modal helper missing
if (typeof showStaffModalIfNeeded !== "function") {
  window.showStaffModalIfNeeded = (id, data) => {
    console.log("‚ÑπÔ∏è (No modal implemented) Order:", id, data.table || data.table_no);
  };
}


/* Staff page orders listener & renderer (replace existing staff script) */
const orderList = document.getElementById("orderList");
const orderDate = document.getElementById("orderDate");
let staffCurrentFilter = "incoming";

const phoneMap = {
  "mille 1": "6282217091699",
  "mille 2": "6281220039853",
  "mille 3": "6282261863984",
};

function jakartaDateStringFromInput() {
  // ensure the selected calendar date is interpreted in Asia/Jakarta timezone
  const d = orderDate.valueAsDate || new Date();
  return d.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' }); // YYYY-MM-DD
}

function tsToJakartaTime(ts) {
  if (!ts) return "‚Äî";
  // Accepts Firestore timestamp or Date
  const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : new Date(ts));
  return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Jakarta' });
}

function styleOrderBox(el, status) {
  const palette = {
    pending:   { bg: "#fff7ed", border: "#f97316", text: "#7c2d12" },
    preparing: { bg: "#eff6ff", border: "#3b82f6", text: "#1e3a8a" },
    served:    { bg: "#ecfdf5", border: "#10b981", text: "#064e3b" },
    cancelled: { bg: "#fee2e2", border: "#ef4444", text: "#991b1b" },
  };
  const c = palette[status] || palette.pending;
  el.style.backgroundColor = c.bg;
  el.style.border = `1px solid ${c.border}`;
  el.style.color = c.text;
}

async function updateOrderStatus(id, newStatus) {
  await db.collection("orders").doc(id).update({ kitchenStatus: newStatus });
  showBanner(`‚úÖ Order ${id} updated to ${newStatus}`, 2500);
}

function renderOrder(id, data) {
  const table = data.table || data.tableName || data.table_no || "‚Äî";
  const items =
   Array.isArray(data.items) ? data.items :
  Array.isArray(data.orderItems) ? data.orderItems :
  Array.isArray(data.products) ? data.products :
  Array.isArray(data.orderedItems) ? data.orderedItems :
  (data.items && typeof data.items === "object") ? Object.values(data.items) :
  (data.orderData?.items && typeof data.orderData.items === "object") ? Object.values(data.orderData.items) :
  [];
console.debug("üì¶ Items for", id, items);
  const guest = data.guestName || data.guest || "Guest";
  const rawTs = data.timestamp || data.createdAt;
 const timestamp = rawTs?.toDate?.() ? rawTs.toDate() : new Date(rawTs || Date.now());
  const time = tsToJakartaTime(timestamp);
  const kitchenStatus = (data.kitchenStatus || data.status || "pending").toLowerCase();
  const paymentStatus = (data.paymentStatus || "unknown").toLowerCase();
  const method = (data.paymentMethod || "unspecified").toLowerCase();
  const subtotal = +data.subtotal || 0;
  const discount = +data.discount || 0;
  const tax = +data.tax || 0;
  const deliveryFee = +data.deliveryFee || 0;
  const grandTotal = +data.grandTotal || subtotal - discount + tax + deliveryFee;

  const div = document.createElement("div");
  div.className = "order";
  div.dataset.status = kitchenStatus;
  styleOrderBox(div, kitchenStatus);

  // ‚úÖ Detailed inline rendering for staff view
  const itemLines = (items || [])
    .map(i => {
      const name = i.name || i.itemName || i.product || "Unnamed";
const qty = i.qty || i.quantity || i.qtyOrdered || 1;
const price = i.price || i.unitPrice || i.cost || 0;
      const line = price
        ? `${qty}√ó ${name} ‚Äî Rp${(qty * price).toLocaleString("id-ID")}`
        : `${qty}√ó ${name}`;
      return `<li>${line}</li>`;
    })
    .join("");

  div.innerHTML = `
    <p><strong>Table:</strong> ${table} <span style="float:right">${time}</span></p>
    <p><strong>Guest:</strong> ${guest}</p>
    <p><strong>Items:</strong></p>
    <ul style="margin:4px 0 8px 16px; padding:0; list-style-type:disc;">${itemLines}</ul>
    <p><strong>Subtotal:</strong> Rp${subtotal.toLocaleString("id-ID")}</p>
    ${discount ? `<p><strong>Discount:</strong> -Rp${discount.toLocaleString("id-ID")}</p>` : ""}
    ${tax ? `<p><strong>Tax:</strong> Rp${tax.toLocaleString("id-ID")}</p>` : ""}
    ${deliveryFee ? `<p><strong>Delivery Fee:</strong> Rp${deliveryFee.toLocaleString("id-ID")}</p>` : ""}
    <p><strong>Total:</strong> <span style="color:#16a34a;font-weight:bold;">Rp${grandTotal.toLocaleString("id-ID")}</span></p>
    <p><strong>Payment:</strong> ${method.toUpperCase()} (${paymentStatus})</p>
    <p class="status">Status: ${kitchenStatus.toUpperCase()}</p>
  `;

  // ‚úÖ Action buttons (kitchen status)
  const controls = document.createElement("div");
  ["preparing", "served", "cancelled"].forEach(s => {
    const btn = document.createElement("button");
    btn.textContent = s;
    btn.className = "btn minimal";
    btn.onclick = () => updateOrderStatus(id, s);
    controls.appendChild(btn);
  });
  div.appendChild(controls);

  // ‚úÖ Optional contact button (for Mille tables)
  const lower = String(table).toLowerCase();
  const phone =
    (lower.includes("mille 1") && phoneMap["mille 1"]) ||
    (lower.includes("mille 2") && phoneMap["mille 2"]) ||
    (lower.includes("mille 3") && phoneMap["mille 3"]);
  if (phone) {
    const wa = document.createElement("a");
    wa.className = "btn contact";
    wa.href = `https://wa.me/${phone}?text=Order%20${encodeURIComponent(id)}%20(${encodeURIComponent(table)})`;
    wa.target = "_blank";
    wa.textContent = "üí¨ Contact Mille";
    div.appendChild(wa);
  }

  return div;
}


let loadedOrders = new Map();
let unsubscribeOrders = null; // üß© hold the Firestore listener reference

function loadOrders() {
  const yyyyMmDd = jakartaDateStringFromInput();
  if (!yyyyMmDd) return console.error("‚ùå Invalid date (staff)");

  let initialLoadDone = false;

  // üß© Stop previous snapshot listener before starting a new one
  if (unsubscribeOrders) {
    console.debug("üßπ Unsubscribing previous Firestore listener");
    try { unsubscribeOrders(); } catch {}
  }

  unsubscribeOrders = db.collection("orders")
    .where("date", "==", yyyyMmDd)
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      console.debug("üìÖ Listening for date:", yyyyMmDd, "‚Üí got", snapshot.size, "docs");
      snapshot.docChanges().forEach(change => {
        const doc = change.doc;
        const data = doc.data();

        if (change.type === "added") {
          console.log("üÜï Added order:", doc.id);
          const card = renderOrder(doc.id, data);
          orderList.prepend(card);
          loadedOrders.set(doc.id, card);

          // Play chime & repeat only for truly new live orders
          if (initialLoadDone) {
            AudioChime.requestChime?.();
            RepeatingChime.start(doc.id);
          }
        }

        if (change.type === "modified") {
// ‚úÖ Debounce modification updates to avoid premature replace
          setTimeout(() => {
            const card = loadedOrders.get(doc.id);
            if (!card) return;
            const updated = renderOrder(doc.id, data);
            if (orderList.contains(card)) {
              orderList.replaceChild(updated, card);
              loadedOrders.set(doc.id, updated);
            } else {
              // This usually happens only once per session, safe to ignore
              console.debug("‚ÑπÔ∏è Deferred replace for", doc.id);
            }
          }, 100); // wait 100ms to ensure DOM insertion finished
          const status = (data.kitchenStatus || data.status || "").toLowerCase();
          if (status !== "pending") {
            setTimeout(() => RepeatingChime.stop(doc.id), 500);
          }
        }

        if (change.type === "removed") {
          const card = loadedOrders.get(doc.id);
          if (card) card.remove();
          loadedOrders.delete(doc.id);
        }
      });

      filterOrders(staffCurrentFilter);
      // After first batch processed, mark initial load done
      initialLoadDone = true;
    }, err => console.error("üî• Snapshot error:", err));
}

function filterOrders(status) {
  staffCurrentFilter = status;
  document.querySelectorAll("#orderFilters .btn").forEach(btn =>
    btn.classList.toggle("active", btn.textContent.toLowerCase().includes(status))
  );

  document.querySelectorAll(".order").forEach(el => {
    const st = (el.dataset.status || "").toLowerCase();
    const incoming = status === "incoming" && ["pending", "preparing"].includes(st);
    el.style.display = (status === "all" || incoming || st === status) ? "" : "none";
  });
}

orderDate.addEventListener("change", loadOrders);
// ‚úÖ Global function accessible to both listeners
 function setTodayJakarta() {
   const now = new Date();
   const formatter = new Intl.DateTimeFormat('en-CA', {
     timeZone: 'Asia/Jakarta',
     year: 'numeric',
     month: '2-digit',
     day: '2-digit'
   });
   orderDate.value = formatter.format(now);
 }

 window.addEventListener("DOMContentLoaded", async () => {
   // ‚úÖ Always set Jakarta date before anything else
   setTodayJakarta();

   // ‚úÖ Prime audio (for Chrome autoplay restrictions)
   if (typeof AudioChime !== "undefined") AudioChime.primeMutedAutoplay();
   document.body.addEventListener("click", () => {
     try { AudioChime.primeMutedAutoplay(); } catch {}
  }, { once: true });

   // ‚úÖ Stop any repeating chime if opened via notification
   try {
     const params = new URLSearchParams(location.search);
     const orderId = params.get("orderId");
     if (orderId) {
       RepeatingChime.stop(orderId);
       window.staffShownModals = window.staffShownModals || new Set();
       window.staffShownModals.add(orderId);
     }
   } catch {}

   // ‚úÖ Enable Firestore and load data
   try {
     try {
   await firebase.firestore().enableNetwork();
 } catch (e) {
   console.debug("Firestore network already active or cached:", e);
 }
     console.log("‚úÖ Firestore ready ‚Äî loading orders for", orderDate.value);
   } catch (err) {
     console.warn("‚ö†Ô∏è Firestore enableNetwork failed, proceeding anyway:", err);
   }

   loadOrders();
 });
</script>
</body>
</html>
