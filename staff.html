<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Staff Dashboard</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body.staff {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 16px;
    }

    h1 {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 12px;
    }

    #orderFilters {
      position: sticky;
      top: 0;
      background: #f9f9f9;
      padding: 10px 0;
      z-index: 10;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .order {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      font-size: 0.95rem;
    }

    .status {
      font-weight: bold;
      color: #555;
      margin-top: 6px;
    }

    .btn {
      margin: 6px 4px 0 0;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .pending { background: #ffeeba; }
    .preparing { background: #bee5eb; }
    .served { background: #c3e6cb; }
    .contact { background: #25D366; color: white; }

    #orderDate {
      font-size: 1rem;
      padding: 6px;
      margin: 10px 0;
      width: 100%;
      max-width: 300px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    @media (max-width: 600px) {
      h1 { font-size: 1.2rem; }
      .btn { display: block; width: 100%; margin: 6px 0; }
      .order { font-size: 0.9rem; padding: 10px; }
    }
  </style>
</head>
<body class="staff">
  <h1>ðŸ“‹ Incoming Orders</h1>
  
  <div id="orderFilters">
    <button onclick="filterOrders('all')" class="btn">All</button>
    <button onclick="filterOrders('incoming')" class="btn">Incoming</button>
    <button onclick="filterOrders('served')" class="btn">Served</button>
    <button onclick="filterOrders('cancelled')" class="btn">Cancelled</button>
  </div>

  <h2 style="text-align:center;">Orders for <input type="date" id="orderDate" /></h2>
  <div id="orderList"></div>

  <audio id="newOrderSound" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3" preload="auto"></audio>
  <button id="installBtn" style="display:none;">Install App</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
  authDomain: "e-loyalty-12563.firebaseapp.com",
  projectId: "e-loyalty-12563",
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const orderList = document.getElementById("orderList");
const orderDate = document.getElementById("orderDate");
orderDate.valueAsDate = new Date();

let currentFilter = "all";

// ðŸ“± Define phone numbers for each Mille
const phoneMap = {
  "mille 1": "6282217091699", // replace with real number A
  "mille 2": "6281220039853", // replace with real number B
  "mille 3": "6282261863984", // replace with real number C
};

const messaging = firebase.messaging();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then((reg) => {
      console.log("Service Worker registered", reg);
      messaging.useServiceWorker(reg);
    })
    .catch(err => console.error("SW registration failed:", err));
}

const isMilleTable = /mille\s*[123]/i.test(data.table || "");


// Request permission for notifications
async function initFCM() {
  try {
    const token = await messaging.getToken({
      vapidKey: "VPFwm_C_GPv0AAtxLfI1LWOZegHj4t8k5nLlD9s5ZLs"
    });
    console.log("FCM Token:", token);

    // ðŸ‘‰ Save this token to Firestore under staff-users collection
    // db.collection("staffTokens").doc(token).set({ token });

  } catch (err) {
    console.error("Unable to get FCM token", err);
  }
}

messaging.onMessage((payload) => {
  console.log("Message received. ", payload);
  // Foreground notification
  new Notification(payload.notification.title, {
    body: payload.notification.body,
    icon: "/icons/icon-192.png"
  });
});

initFCM();


function renderOrder(id, data) {
  const table = (data.table || "").toLowerCase();
  const status = data.status || "incoming";
  const time = data.timestamp?.toDate?.().toLocaleTimeString("id-ID",{hour:'2-digit',minute:'2-digit'}) || "â€”";

  const div = document.createElement("div");
  div.className = "order";
  div.dataset.status = status;

  div.innerHTML = `
    <p><strong>Table:</strong> ${data.table || "?"}</p>
    <p><strong>Items:</strong> ${(data.items || []).map(i => `${i.qty}Ã— ${i.name}`).join(", ")}</p>
    <p><strong>Status:</strong> ${status}</p>
    <p><strong>Time:</strong> ${time}</p>
  `;

  // âœ… Contact Mille button logic
  let phone = null;
  if (table.includes("mille 1")) phone = phoneMap["mille 1"];
  else if (table.includes("mille 2")) phone = phoneMap["mille 2"];
  else if (table.includes("mille 3")) phone = phoneMap["mille 3"];

  if (phone) {
    const waBtn = document.createElement("a");
    waBtn.className = "btn contact";
    waBtn.href = `https://wa.me/${phone}?text=Hello,%20please%20check%20order%20${id}%20(${data.table})`;
    waBtn.target = "_blank";
    waBtn.textContent = "ðŸ’¬ Contact Mille";
    div.appendChild(waBtn);
  }

  return div;
}

function loadOrders() {
  const yyyyMmDd = new Date(orderDate.value).toISOString().split("T")[0];
  db.collection("orders")
    .where("date", "==", yyyyMmDd)
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      orderList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const card = renderOrder(doc.id, data);
        if (currentFilter === "all" || card.dataset.status === currentFilter) {
          orderList.appendChild(card);
        }
      });
    });
}

function filterOrders(status) {
  currentFilter = status;
  loadOrders();
}

orderDate.addEventListener("change", loadOrders);
loadOrders();
</script>
</body>
</html>
