<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="/manifest.json" />
  <meta charset="UTF-8" />
  <title>Staff Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .order {
      background: white;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .status {
      font-weight: bold;
      color: #555;
    }
    .btn {
      margin-top: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .pending { background: #ffeeba; }
    .preparing { background: #bee5eb; }
    .served { background: #c3e6cb; }
  </style>
</head>
<body>
  <h1>📋 Incoming Orders</h1>
  <div id="orderFilters">
  <button onclick="filterOrders('all')">All</button>
  <button onclick="filterOrders('incoming')">Incoming</button>
  <button onclick="filterOrders('served')">Served</button>
  <button onclick="filterOrders('cancelled')">Cancelled</button>
  <!-- staff.html -->
<h2>Orders for <input type="date" id="orderDate" /></h2>
<ul id="orderList"></ul>
</div>
  <div id="orderList"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<audio id="newOrderSound" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3" preload="auto"></audio>  <script>
      // 🔘 Track which status is currently selected
  const firebaseConfig = {
    apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
    authDomain: "e-loyalty-12563.firebaseapp.com",
    projectId: "e-loyalty-12563",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let selectedStatus = "incoming";
  let liveMode = true;
  let allOrders = [];
  let previousOrderIds = new Set();
  let userHasInteracted = false;

  const orderDateInput = document.getElementById("orderDate");
  const orderList = document.getElementById("orderList");
  const today = new Date().toISOString().split("T")[0];
  orderDateInput.value = today;

  ["click", "touchstart", "keydown"].forEach(evt => {
    window.addEventListener(evt, () => userHasInteracted = true, { once: true });
  });

  // ⏱️ Auto-disable live mode after 10 minutes of inactivity
setTimeout(() => {
  if (!userHasInteracted) liveMode = false;
}, 600000);


  // 🔄 Toggle between live and date mode
  orderDateInput.addEventListener("change", () => {
    liveMode = false;
    fetchOrdersForDate(orderDateInput.value);
  });

  function fetchOrdersForDate(dateStr) {
    const start = new Date(dateStr); start.setHours(0, 0, 0, 0);
    const end = new Date(dateStr); end.setHours(23, 59, 59, 999);

    db.collection("orders")
      .where("timestamp", ">=", start)
      .where("timestamp", "<=", end)
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allOrders = orders;
        renderFilteredOrders();
      });
  }

  // ✅ Single listener for live updates
  db.collection("orders")
    .orderBy("timestamp", "desc")
    .limit(20)
    .onSnapshot(snapshot => {
      if (!liveMode) return;

      const currentOrderIds = new Set();
      const updatedOrders = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        currentOrderIds.add(id);
        updatedOrders.push({ id, ...data });

        if (!previousOrderIds.has(id) && userHasInteracted) {
          document.getElementById("newOrderSound").play();
          showNotification(`🆕 New order from Table ${data.table || "?"}`);
        }
      });

      previousOrderIds = currentOrderIds;
      allOrders = updatedOrders;
      renderFilteredOrders();
    });

  function renderFilteredOrders() {
    const filtered = allOrders.filter(order => {
      if (selectedStatus === "all") return true;
      if (selectedStatus === "incoming") return ["pending", "preparing"].includes(order.status);
      return order.status === selectedStatus;
    });
    renderOrders(filtered);
  }

  function filterOrders(status) {
    selectedStatus = status;
    renderFilteredOrders();
  }

  function renderOrders(orders) {
    orderList.innerHTML = "";
    orders.forEach(order => {
      const div = document.createElement("div");
      div.className = `order ${order.status}`;
      div.innerHTML = `
        <div><strong>Table:</strong> ${order.table || "Unknown"}</div>
        <div><strong>Items:</strong> ${
          Array.isArray(order.items)
            ? order.items.map(i => `${i.name} x${i.qty}`).join(", ")
            : "No items found"
        }</div>
        <div><strong>Time:</strong> ${order.timestamp?.toDate().toLocaleTimeString() || "—"}</div>
        <div class="status">Status: ${order.status}</div>
        <button class="btn" onclick="updateStatus('${order.id}', 'preparing')">Preparing</button>
        <button class="btn" onclick="updateStatus('${order.id}', 'served')">Served</button>
        <button class="btn" onclick="updateStatus('${order.id}', 'cancelled')">Cancel</button>
        <button class="btn" onclick="modifyOrder('${order.id}', ${JSON.stringify(order.items)})">Modify</button>
      `;
      orderList.appendChild(div);
    });
  }

  async function updateStatus(id, status) {
  try {
    await db.collection("orders").doc(id).update({ status });

    if (status === "served") {
      const doc = await db.collection("orders").doc(id).get();
      const order = doc.data();

      if (order.userId) {
        await db.collection("members")
          .doc(order.userId)
          .collection("transactions")
          .add({
            ...order,
            importedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
      }
    }
  } catch (error) {
    console.error("Error updating status or importing transaction:", error);
  }
}

  function modifyOrder(orderId, items) {
    const updatedItems = items.map(item => {
      const newQty = prompt(`Modify quantity for ${item.name}:`, item.qty);
      return {
        name: item.name,
        qty: parseInt(newQty) || item.qty,
        price: item.price || 0
      };
    });
    if (updatedItems.some(i => i.qty <= 0)) {
      alert("Quantity must be greater than 0");
      return;
    }
    db.collection("orders").doc(orderId).update({ items: updatedItems });
  }

  function showNotification(message) {
    const notif = document.createElement("div");
    notif.textContent = message;
    Object.assign(notif.style, {
      position: "fixed", bottom: "20px", right: "20px",
      background: "#333", color: "#fff", padding: "10px 20px",
      borderRadius: "6px", boxShadow: "0 2px 6px rgba(0,0,0,0.3)", zIndex: "1000"
    });
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 4000);
  }

  // Initial load
  fetchOrdersForDate(today);
</script>
</body>
</html>