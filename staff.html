<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Staff Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #f9f9f9;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #3b82f6;
      --success: #10b981;
      --danger: #ef4444;
    }
    body.staff {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      margin: 0; padding: 18px;
      color: #111827;
    }
    h1 { text-align:center; margin: 0 0 12px; font-size: 1.4rem; }
    #orderControls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center; margin-bottom:12px; position: sticky; top:0; background:var(--bg); padding:8px; z-index: 30; border-bottom:1px solid #e5e7eb; }
    .btn { border: none; padding: 8px 12px; border-radius:8px; background:#e5e7eb; cursor:pointer; font-size:0.95rem; transition: background .15s; }
    .btn:hover { background:#d1d5db; }
    .btn.active { background: var(--accent); color: #fff; }
    #orderDate { padding:6px 8px; border-radius:8px; border:1px solid #d1d5db; font-size:1rem; }
    #orderList { margin-top: 12px; max-width: 840px; margin-left:auto; margin-right:auto; }
    .order { background: var(--card); border-radius:10px; padding:12px; margin-bottom:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: box-shadow .18s, border-color .18s; }
    .order:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    .meta { display:flex; justify-content:space-between; gap: 12px; align-items:center; flex-wrap:wrap; }
    .order p { margin:6px 0; color:#111827; font-size:0.96rem; }
    .order ul { margin:6px 0 8px 18px; padding:0; }
    .controls-row { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn.minimal { background:#f3f4f6; border-radius:6px; padding:7px 10px; }
    .btn.contact { background:#25D366; color:white; padding:7px 10px; border-radius:6px; text-decoration:none; display:inline-block; }
    .loading, .empty, .error { text-align:center; color:var(--muted); padding:18px 0; }
    .badge { padding:6px 8px;border-radius:999px;font-size:0.85rem; font-weight:600; }
    .badge.pending { background:#fff7ed; color:#7c2d12; border:1px solid #f97316; }
    .badge.preparing { background:#eff6ff; color:#1e3a8a; border:1px solid #3b82f6; }
    .badge.served { background:#ecfdf5; color:#064e3b; border:1px solid #10b981; }
    .badge.cancelled { background:#fee2e2; color:#991b1b; border:1px solid #ef4444; }
    .topline { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    @media (max-width:600px) {
      .meta { flex-direction:column; align-items:flex-start; }
      .controls-row { width:100%; }
      #orderControls { padding-left:8px; padding-right:8px; }
    }
  </style>
</head>
<body class="staff">
  <h1>📋 Incoming Orders</h1>

  <div id="orderControls">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <button class="btn active" data-filter="all">All</button>
      <button class="btn" data-filter="incoming">Incoming</button>
      <button class="btn" data-filter="served">Served</button>
      <button class="btn" data-filter="cancelled">Cancelled</button>
    </div>
    <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
      <label for="orderDate" style="font-size:0.9rem; color:var(--muted);">Orders for</label>
      <input id="orderDate" type="date" />
    </div>
  </div>

  <div id="orderList" role="list"></div>

  <audio id="newOrderSound" preload="auto" src="https://albopilo.github.io/newest-qr-menu/assets/sound.mp3"></audio>

  <!-- Firebase (Compat) SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
  (function(){
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase safely
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const orderList = document.getElementById('orderList');
    const orderDate = document.getElementById('orderDate');
    const filterButtons = Array.from(document.querySelectorAll('.btn[data-filter]'));
    const audio = document.getElementById('newOrderSound');
    const phoneMap = { "mille 1":"6282217091699","mille 2":"6281220039853","mille 3":"6282261863984" };

    let unsubscribe = null;
    let currentFilter = 'incoming';
    let initialLoad = true;

    function escapeHtml(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function formatDate(d){const j=new Date(d.toLocaleString('en-US',{timeZone:'Asia/Jakarta'}));return `${j.getFullYear()}-${String(j.getMonth()+1).padStart(2,'0')}-${String(j.getDate()).padStart(2,'0')}`;}
    function formatTime(ts){const d=ts?.toDate?.()||new Date(ts);return d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Jakarta'});}
    function setToday(){orderDate.value=formatDate(new Date());}
    function show(msg,type='loading'){orderList.innerHTML=`<div class="${type}">${msg}</div>`;}

    function extractItems(data){
      const cands=[data?.items,data?.orderItems,data?.products,data?.orderedItems,data?.orderData?.items,data?.orderData?.products];
      for(const c of cands){if(Array.isArray(c))return c;if(typeof c==='string'){try{const p=JSON.parse(c);if(Array.isArray(p))return p;}catch(e){}}}
      return [];
    }

    function badge(status){
      const s=(status||'').toLowerCase();
      if(s.includes('prepar'))return `<span class="badge preparing">PREPARING</span>`;
      if(s.includes('serve'))return `<span class="badge served">SERVED</span>`;
      if(s.includes('cancel'))return `<span class="badge cancelled">CANCELLED</span>`;
      return `<span class="badge pending">PENDING</span>`;
    }

    function createOrder(id,data){
      const table=data.table||data.tableName||'—';
      const guest=data.guestName||'Guest';
      const items=extractItems(data);
      const time=formatTime(data.timestamp||data.createdAt);
      const status=(data.kitchenStatus||data.status||'pending').toLowerCase();
      const method=(data.paymentMethod||'unspecified').toUpperCase();
      const payStat=(data.paymentStatus||'unknown').toLowerCase();
      const subtotal=+data.subtotal||0,discount=+data.discount||0,tax=+data.tax||0,fee=+data.deliveryFee||0;
      const total=(+data.grandTotal)||(subtotal-discount+tax+fee);

      const el=document.createElement('div');
      el.className='order';
      el.dataset.status=status;
      el.dataset.id=id;

      el.innerHTML=`
        <div class="meta">
          <div>
            <div class="topline"><strong>${escapeHtml(table)}</strong><span style="color:var(--muted)">${escapeHtml(guest)}</span></div>
            <p><strong>Items:</strong></p>
            <ul>${items.map(i=>`<li>${i.qty||1}× ${escapeHtml(i.name||i.itemName||'Unnamed')} — Rp${((i.qty||1)*(i.price||0)).toLocaleString('id-ID')}</li>`).join('')}</ul>
          </div>
          <div style="text-align:right">
            ${badge(status)}<div style="color:var(--muted);font-size:0.9rem;margin-top:6px;">${method} (${payStat})</div>
            <div style="color:var(--muted);font-size:0.9rem;margin-top:6px;">${time}</div>
          </div>
        </div>
        <p><strong>Total:</strong> <span style="color:var(--success);font-weight:700">Rp${total.toLocaleString('id-ID')}</span></p>
        <p class="status">Status: ${status.toUpperCase()}</p>`;

      const ctr=document.createElement('div');
      ctr.className='controls-row';
      ['preparing','served','cancelled'].forEach(s=>{
        const b=document.createElement('button');
        b.className='btn minimal';b.textContent=s;b.onclick=()=>updateStatus(id,s);ctr.appendChild(b);
      });
      const lower=table.toLowerCase();
      const phone=(lower.includes('mille 1')&&phoneMap['mille 1'])||(lower.includes('mille 2')&&phoneMap['mille 2'])||(lower.includes('mille 3')&&phoneMap['mille 3']);
      if(phone){const a=document.createElement('a');a.className='btn contact';a.href=`https://wa.me/${phone}?text=${encodeURIComponent('Order '+id+' ('+table+')')}`;a.target='_blank';a.textContent='💬 Contact Mille';ctr.appendChild(a);}
      el.appendChild(ctr);
      return el;
    }

    async function updateStatus(id,status){
      try{await db.collection('orders').doc(id).update({kitchenStatus:status});toast(`✅ ${id} → ${status}`);}
      catch(e){toast('⚠️ Failed updating');}
    }

    function toast(msg,ms=2000){
      const t=document.createElement('div');t.textContent=msg;
      Object.assign(t.style,{position:'fixed',bottom:'24px',left:'50%',transform:'translateX(-50%)',background:'#111',color:'#fff',padding:'8px 12px',borderRadius:'8px',zIndex:9999});
      document.body.appendChild(t);setTimeout(()=>t.remove(),ms);
    }

    function applyFilter(f){
      currentFilter=f;
      filterButtons.forEach(b=>b.classList.toggle('active',b.dataset.filter===f));
      document.querySelectorAll('.order').forEach(el=>{
        const s=(el.dataset.status||'').toLowerCase();
        const show=(f==='all'||(f==='incoming'&&['pending','preparing'].includes(s))||s===f);
        el.style.display=show?'':'none';
      });
      if(!document.querySelector('.order:not([style*="display: none"])')) show('No orders match filter','empty');
    }

    async function loadOrders(){
      if(unsubscribe) unsubscribe();
      const dateStr=orderDate.value;
      if(!dateStr){show('Invalid date','error');return;}
      show('Loading orders…');
      const start=new Date(`${dateStr}T00:00:00+07:00`),end=new Date(`${dateStr}T23:59:59+07:00`);
      unsubscribe=db.collection('orders')
        .where('timestamp','>=',start).where('timestamp','<=',end)
        .orderBy('timestamp','desc')
        .onSnapshot(snap=>{
          if(snap.empty){show('No orders for this date.','empty');return;}
          const frag=document.createDocumentFragment();
          snap.docs.forEach(d=>frag.appendChild(createOrder(d.id,d.data())));
          orderList.innerHTML='';orderList.appendChild(frag);
          applyFilter(currentFilter);
          if(!initialLoad){try{audio.play();}catch(e){}}
          initialLoad=false;
        },err=>{
          show('Snapshot error: '+err.message,'error');
          retryLater();
        });
    }

    function retryLater(){
      const retry=document.createElement('button');
      retry.className='btn';retry.textContent='Retry Connection';
      retry.onclick=()=>{retry.remove();loadOrders();};
      orderList.appendChild(retry);
    }

    // Setup controls
    filterButtons.forEach(b=>b.onclick=()=>applyFilter(b.dataset.filter));
    orderDate.onchange=loadOrders;

    document.addEventListener('DOMContentLoaded',()=>{
      setToday();
      setTimeout(loadOrders,300);
    });
  })();
  </script>
</body>
</html>
