<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    .summary { max-width: 500px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .summary h2 { margin-bottom: 1em; }
    .summary ul { list-style: none; padding: 0; }
    .summary li { margin-bottom: 0.5em; }
    .label { font-weight: bold; }
    #confirmBtn {
      margin-top: 20px;
      padding: 12px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    #confirmBtn:hover { background-color: #45a049; }
  </style>
</head>
<body>
  <div class="summary">
    <h2>Order Summary</h2>
    <p><span class="label">Table:</span> <span id="tableDisplay"></span></p>
    <p><span class="label">Guest:</span> <span id="guestDisplay"></span></p>
    <ul id="itemsList"></ul>
    <p><span class="label">Subtotal:</span> <span id="subtotalDisplay"></span></p>
    <p><span class="label">Discount:</span> <span id="discountDisplay"></span></p>
    <p><span class="label">Tax:</span> <span id="taxDisplay"></span></p>
    <p><span class="label">Total:</span> <span id="totalDisplay"></span></p>

    <p id="deliveryRow" style="display:none;">
      <span class="label">Delivery Fee:</span> <span id="deliveryFeeDisplay"></span>
    </p>

    <p id="grandTotalRow" style="display:none;">
      <span class="label">Grand Total:</span> <span id="grandTotalDisplay"></span>
    </p>

    <div id="voucherSection" style="margin-top:10px;">
      <label for="voucherInput" class="label">Voucher Code:</label>
      <input type="text" id="voucherInput" style="width:100%;padding:8px;margin:4px 0;" />
      <button id="applyVoucherBtn" style="padding:8px 12px;">Apply</button>
      <p id="voucherMsg" style="color:#d33;font-size:0.9em;"></p>
    </div>

    <div id="paymentSection" style="margin:20px 0;">
      <label class="label">Payment Method:</label><br>
      <input type="radio" name="paymentMethod" id="payCash" value="cash"> 
      <label for="payCash">Cash</label><br>
      <input type="radio" name="paymentMethod" id="payQRIS" value="qris"> 
      <label for="payQRIS">QRIS</label>

      <div id="cashInstruction" style="display:none; margin-top:10px; color:#555;">
        ðŸ’µ Please pay at the receptionist on 1st floor.
      </div>
    </div>

    <p><span class="label">Open Hours:</span> 08:30 - 19:30</p>
    <button id="confirmBtn">âœ… Confirm Order</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDNvgS_PqEHU3llqHt0XHN30jJgiQWLkdc",
  authDomain: "e-loyalty-12563.firebaseapp.com",
  projectId: "e-loyalty-12563",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// URL params
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get("orderId");
let status = urlParams.get("status");

// DOM elements
const tableDisplay = document.getElementById("tableDisplay");
const guestDisplay = document.getElementById("guestDisplay");
const itemsList = document.getElementById("itemsList");
const subtotalDisplay = document.getElementById("subtotalDisplay");
const discountDisplay = document.getElementById("discountDisplay");
const taxDisplay = document.getElementById("taxDisplay");
const totalDisplay = document.getElementById("totalDisplay");
const deliveryRow = document.getElementById("deliveryRow");
const deliveryFeeDisplay = document.getElementById("deliveryFeeDisplay");
const grandTotalRow = document.getElementById("grandTotalRow");
const grandTotalDisplay = document.getElementById("grandTotalDisplay");
const confirmBtn = document.getElementById("confirmBtn");
const voucherInput = document.getElementById("voucherInput");
const applyVoucherBtn = document.getElementById("applyVoucherBtn");
const voucherMsg = document.getElementById("voucherMsg");
const payCash = document.getElementById("payCash");
const payQRIS = document.getElementById("payQRIS");
const cashInstruction = document.getElementById("cashInstruction");
const paymentSection = document.getElementById("paymentSection");

// Order variables
let table = "unknown";
let guestName = "Guest";
let items = [];
let subtotal = 0;
let discount = 0;
let tax = 0;
let deliveryFee = 0;
let paymentMethod = "";
let qrisOrderCreated = false;

// Initialize page
document.addEventListener("DOMContentLoaded", async () => {
  try {
    // Fetch order from Firestore if orderId exists
    if (orderId) {
      const doc = await db.collection("orders").doc(orderId).get();
      if (doc.exists) {
        const data = doc.data();
        table = data.table || table;
        guestName = data.guestName || guestName;
        items = data.items || [];
        subtotal = data.subtotal || 0;
        discount = data.discount || 0;
        tax = data.tax || 0;
        deliveryFee = data.deliveryFee || 0;
        paymentMethod = data.paymentMethod || "";
        if (data.paymentStatus === "success") status = "success";
      }
    } else {
      // Get from URL params
      table = urlParams.get("table") || table;
      guestName = urlParams.get("guestName") || guestName;
      try { items = JSON.parse(decodeURIComponent(urlParams.get("items") || "[]")); } 
      catch(e){ console.error(e); }
      subtotal = Number(urlParams.get("subtotal")) || 0;
      discount = Number(urlParams.get("discount")) || 0;
      tax = Number(urlParams.get("tax")) || 0;
    }

    // Update DOM
    tableDisplay.textContent = table;
    guestDisplay.textContent = guestName;
    itemsList.innerHTML = "";
    items.forEach(item => {
      const li = document.createElement("li");
      li.textContent = `${item.qty} Ã— ${item.name}`;
      itemsList.appendChild(li);
    });

    // Handle delivery fee for certain tables
    if (/mille\s*1/i.test(table) || /mille\s*3/i.test(table)) {
      deliveryFee = 10000;
      deliveryRow.style.display = "block";
      deliveryFeeDisplay.textContent = `Rp${deliveryFee.toLocaleString("id-ID")}`;
    }

    // Pre-select payment method if available
    if (paymentMethod === "cash") payCash.checked = true;
    if (paymentMethod === "qris") payQRIS.checked = true;
    if (paymentMethod === "cash") cashInstruction.style.display = "block";

    // Disable UI if order already successful
    if (status === "success") {
      confirmBtn.disabled = true;
      confirmBtn.textContent = "âœ… Order Successful";
      voucherInput.disabled = true;
      applyVoucherBtn.disabled = true;
      paymentSection.style.display = "none";
    }

    // Initial summary render
    renderSummary();

    // Payment selection
    payCash.addEventListener("change", () => {
      paymentMethod = "cash";
      cashInstruction.style.display = "block";
      confirmBtn.style.display = "block";
    });

    payQRIS.addEventListener("change", async () => {
      paymentMethod = "qris";
      cashInstruction.style.display = "none";
      if (qrisOrderCreated) return;
      try {
        const memberPhone = urlParams.get("memberPhone") || "";
        const memberId = urlParams.get("memberId") || "";
        const { finalTotal, grandTotal } = renderSummary();

        confirmBtn.disabled = true; // disable immediately
        const docRef = await db.collection("orders").add({
          subtotal, discount, tax, deliveryFee,
          total: finalTotal, grandTotal,
          table, guestName, items,
          date: new Date().toISOString().split("T")[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: "pending",
          memberPhone, memberId,
          paymentMethod: "qris",
          paymentStatus: "awaiting-proof"
        });
        qrisOrderCreated = true;
        confirmBtn.style.display = "none";
        window.open(`qris.html?orderId=${docRef.id}`, "_blank");
      } catch (err) {
        console.error(err);
        confirmBtn.disabled = false;
        alert("âš ï¸ Failed to prepare QRIS payment. Please try again.");
      }
    });

    // Voucher application
    applyVoucherBtn.addEventListener("click", async () => {
      const code = voucherInput.value.trim().toUpperCase();
      voucherMsg.style.color = "#d33";
      if (!code) { 
        voucherMsg.textContent = "âš ï¸ Please enter a voucher code."; 
        setTimeout(() => voucherMsg.textContent = "", 5000);
        return; 
      }

      try {
        const snap = await db.collection("vouchers").where("code", "==", code).limit(1).get();
        if (snap.empty) { 
          voucherMsg.textContent = "âŒ Invalid voucher code."; 
          setTimeout(() => voucherMsg.textContent = "", 5000);
          return; 
        }
        const voucherDoc = snap.docs[0];
        const voucherRef = db.collection("vouchers").doc(voucherDoc.id);

        await db.runTransaction(async (tx) => {
          const today = new Date(); today.setHours(0,0,0,0);
          const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
          const redemptionSnap = await tx.get(
            voucherRef.collection("redemptions")
              .where("timestamp", ">=", today)
              .where("timestamp", "<", tomorrow)
          );

          if (voucherDoc.data().limitPerDay && redemptionSnap.size >= voucherDoc.data().limitPerDay)
            throw new Error("DAILY_LIMIT_REACHED");

          // Remove previous redemption
          if (orderId) {
            const orderDoc = await tx.get(db.collection("orders").doc(orderId));
            if (orderDoc.exists && orderDoc.data().voucherId) {
              const prevRedemptions = await tx.get(
                db.collection("vouchers").doc(orderDoc.data().voucherId)
                  .collection("redemptions").where("orderId", "==", orderId)
              );
              prevRedemptions.forEach(doc => tx.delete(doc.ref));
            }
          }

          // Calculate discount
          let orderDiscount = 0;
          if (voucherDoc.data().type === "percent") orderDiscount = Math.floor(subtotal * (voucherDoc.data().value / 100));
          else if (voucherDoc.data().type === "fixed") orderDiscount = voucherDoc.data().value;

          // Add redemption properly even if orderId is missing
          const redemptionDocRef = orderId ? voucherRef.collection("redemptions").doc(orderId)
                                           : voucherRef.collection("redemptions").doc(`${Date.now()}-${Math.random().toString(36).substr(2,5)}`);
          tx.set(redemptionDocRef, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            table,
            guestName,
            orderId: orderId || null
          });
          if (orderId) tx.update(db.collection("orders").doc(orderId), {
            voucherId: voucherDoc.id,
            discount: orderDiscount
          });
          discount = orderDiscount;
        });

        voucherMsg.style.color = "green";
        voucherMsg.textContent = `âœ… Voucher applied: ${code}`;
        setTimeout(() => voucherMsg.textContent = "", 5000);
        renderSummary();
      } catch (err) {
        if (err.message === "DAILY_LIMIT_REACHED") voucherMsg.textContent = "âŒ This voucher has reached its daily limit.";
        else { console.error(err); voucherMsg.textContent = "âš ï¸ Failed to apply voucher. Try again."; }
        setTimeout(() => voucherMsg.textContent = "", 5000);
      }
    });

    // Confirm button
    confirmBtn.addEventListener("click", async () => {
      if (!paymentMethod) { alert("âš ï¸ Please select a payment method."); return; }
      if (paymentMethod === "qris") { alert("âœ… QRIS order already created. Please check the new tab."); return; }

      try {
        confirmBtn.disabled = true; // prevent double submission
        const memberPhone = urlParams.get("memberPhone") || "";
        const memberId = urlParams.get("memberId") || "";
        const { finalTotal, grandTotal } = renderSummary();
        await db.collection("orders").add({
          subtotal, discount, tax, deliveryFee,
          total: finalTotal, grandTotal,
          table, guestName, items,
          date: new Date().toISOString().split("T")[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          status: "pending",
          memberPhone, memberId,
          paymentMethod: "cash",
          paymentStatus: "pending"
        });
        alert("âœ… Order confirmed! Please pay at the receptionist.");
      } catch (err) {
        console.error(err);
        alert("âŒ Failed to confirm order. Please try again.");
        confirmBtn.disabled = false; // re-enable on failure
      }
    });

  } catch (err) {
    console.error("Error initializing summary:", err);
  }
});

// Render summary remains the same
function renderSummary() {
  subtotalDisplay.textContent = `Rp${subtotal.toLocaleString("id-ID")}`;
  discountDisplay.textContent = `Rp${discount.toLocaleString("id-ID")}`;
  taxDisplay.textContent = `Rp${tax.toLocaleString("id-ID")}`;

  const finalTotal = subtotal - discount + tax;
  totalDisplay.textContent = `Rp${finalTotal.toLocaleString("id-ID")}`;

  const grandTotal = finalTotal + deliveryFee;
  if (deliveryFee > 0) {
    grandTotalDisplay.textContent = `Rp${grandTotal.toLocaleString("id-ID")}`;
    grandTotalRow.style.display = "block";
  } else grandTotalRow.style.display = "none";

  return { finalTotal, grandTotal };
}
</script>

</body>
</html>
